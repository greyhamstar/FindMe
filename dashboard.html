<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>FindMe — Dashboard (Offline)</title>
<link rel="icon" href="assets/logo.png">
<link rel="apple-touch-icon" href="assets/icon-192.png">
<link rel="manifest" href="site.webmanifest">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
</head><body>
<header class="hdr">
  <div class="brand">
    <img class="brand-logo" src="assets/logo.png" alt="FindMe logo">
    <div class="brand-text">
      <span class="brand-name">FindMe</span>
      <span class="brand-tag">Campaign Staffing</span>
    </div>
  </div>
  <div class="hdr-right">
    <nav class="nav">
  <span id="whoami" class="chip"></span>
  <a class="chip" href="index.html">Home</a>
  <a class="chip" id="navPost" href="post_campaign.html">Post</a>
  <a class="chip" id="navPromoters" href="promoters.html">Promoters</a>
  <a class="chip" id="navProfile" href="promoter_profile.html">Profile</a>
  <a class="chip" id="navSuper" href="super.html">Super</a>
  <button id="logoutBtn" class="btn-ghost">Logout</button>
</nav>
    <button class="btn-ghost icon" id="navToggle" aria-label="Menu">☰</button>
  </div>
</header>
<main class="container">
  <div class="card" id="promoterCard">
    <h2>Promoter Dashboard</h2>
    <h3>Campaigns in your region</h3>
    <div class="table-wrap"><table class="table" id="campaignTable"><thead><tr><th>Title</th><th>Region</th><th>Budget</th><th>Apply</th></tr></thead><tbody></tbody></table></div>
    <h3>Invitations</h3>
    <div class="table-wrap"><table class="table" id="inviteTable"><thead><tr><th>Campaign</th><th>Company</th><th>Message</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
    <h3>Your Applications</h3>
    <div class="table-wrap"><table class="table" id="myApps"><thead><tr><th>Date</th><th>Campaign</th><th>Status</th></tr></thead><tbody></tbody></table></div>
  </div>
  <div class="card" id="companyCard">
    <h2>Company Dashboard</h2>
    <div class="grid grid-2"><a class="btn" href="post_campaign.html">Post a Campaign</a><a class="btn-ghost" href="promoters.html">Browse Promoters</a></div>
    <h3>Your Campaigns</h3>
    <div class="table-wrap"><table class="table" id="myCampaigns"><thead><tr><th>Title</th><th>Region</th><th>Budget</th></tr></thead><tbody></tbody></table></div>
    <h3>Applications</h3>
    <div class="table-wrap"><table class="table" id="ownerApps"><thead><tr><th>Date</th><th>Campaign</th><th>Promoter</th><th>Region</th><th>Email</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
  </div>
</main>
<footer class='ftr'>© 2025 FindMe • All rights reserved</footer>
<script type="module">
import { onAuth, signOut, getUserDoc, listCampaignsByRegion, applyToCampaign, invitesForPromoter, listCampaignsByOwner, updateInviteStatus, listApplicationsForPromoter, listApplicationsForOwner, updateApplicationStatus } from './js/offline.js';
const who=document.getElementById('whoami');
const navPost=document.getElementById('navPost');
const navPromoters=document.getElementById('navPromoters');
document.getElementById('logoutBtn').addEventListener('click', ()=>signOut().then(()=>location.href='login.html'));
document.addEventListener('click',e=>{ if(e.target?.id==='navToggle'){document.querySelector('.nav')?.classList.toggle('open')} if(e.target?.closest('.nav')&&e.target.tagName==='A'){document.querySelector('.nav')?.classList.remove('open')} });
onAuth(async (u)=>{
  if(!u){ location.href='login.html'; return; }
  const you=await getUserDoc(u.id);
  who.textContent = you?.role==='promoter' ? `${you.firstName||''} ${you.surname||''} — ${you.region||''}`.trim() : `${you.companyName||''} — ${you.region||''}`;
  const isPromoter = you?.role==='promoter';
  if(isPromoter){ navPost.style.display='none'; navPromoters.style.display='none'; }
  document.getElementById('promoterCard').style.display = isPromoter?'block':'none';
  document.getElementById('companyCard').style.display = isPromoter?'none':'block';

  if(isPromoter){
    const tbody=document.querySelector('#campaignTable tbody'); tbody.innerHTML='';
    (await listCampaignsByRegion(you.region)).forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td data-label="Title">${c.title}</td><td data-label="Region">${c.region}</td><td data-label="Budget"><span class="chip info">R ${c.budget}</span></td><td data-label="Apply"><button class="btn" data-id="${c.id}">Apply</button></td>`;
      tbody.appendChild(tr);
    });
    tbody.addEventListener('click', async (e)=>{
      if(e.target.tagName==='BUTTON'){ await applyToCampaign({campaignId:e.target.getAttribute('data-id'), promoterId:u.id}); alert('Application submitted!'); await renderAppsPromoter(); }
    });
    const itbody=document.querySelector('#inviteTable tbody');
    async function renderInvites(){
      itbody.innerHTML='';
      (await invitesForPromoter(u.id)).forEach(inv=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td data-label="Campaign">${inv.campaignId}</td><td data-label="Company">${inv.companyId}</td><td data-label="Message">${inv.message||'-'}</td><td data-label="Status"><span class="chip ${inv.status==='accepted'?'success':inv.status==='rejected'?'warn':'info'}">${inv.status}</span></td><td data-label="Actions">${inv.status==='sent'?'<button class="btn" data-act="accept" data-id="'+inv.id+'">Accept</button> <button class="btn-ghost" data-act="decline" data-id="'+inv.id+'">Decline</button>':'-'}</td>`;
        itbody.appendChild(tr);
      });
    }
    itbody.addEventListener('click', async (e)=>{
      const act=e.target.getAttribute('data-act'); if(!act) return;
      const id=e.target.getAttribute('data-id');
      await updateInviteStatus(id, act==='accept'?'accepted':'rejected');
      await renderInvites(); alert('Invitation '+act+'ed.');
    });
    async function renderAppsPromoter(){
      const tbodyA=document.querySelector('#myApps tbody'); if(!tbodyA) return;
      tbodyA.innerHTML='';
      (await listApplicationsForPromoter(u.id)).forEach(a=>{
        const dt = new Date(a.createdAt).toLocaleString();
        const row = document.createElement('tr');
        row.innerHTML = `<td data-label="Date">${dt}</td><td data-label="Campaign">${a.campaign?.title||a.campaignId}</td><td data-label="Status"><span class="chip ${a.status==='accepted'?'success':a.status==='rejected'?'warn':'info'}">${a.status||'pending'}</span></td>`;
        tbodyA.appendChild(row);
      });
    }
    await renderInvites(); await renderAppsPromoter();
  } else {
    const tbody=document.querySelector('#myCampaigns tbody'); tbody.innerHTML='';
    (await listCampaignsByOwner(u.id)).forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td data-label="Title">${c.title}</td><td data-label="Region">${c.region}</td><td data-label="Budget">R ${c.budget}</td>`;
      tbody.appendChild(tr);
    });
    async function renderOwnerApps(){
      const tbodyA=document.querySelector('#ownerApps tbody'); if(!tbodyA) return;
      tbodyA.innerHTML='';
      (await listApplicationsForOwner(u.id)).forEach(a=>{
        const dt = new Date(a.createdAt).toLocaleString();
        const promName = ((a.promoter?.firstName||'')+' '+(a.promoter?.surname||'')).trim();
        const row=document.createElement('tr');
        row.innerHTML = `<td data-label="Date">${dt}</td><td data-label="Campaign">${a.campaign?.title||a.campaignId}</td><td data-label="Promoter">${promName||a.promoterId}</td><td data-label="Region">${a.promoter?.region||'-'}</td><td data-label="Email">${a.promoter?.email||'-'}</td><td data-label="Status"><span class="chip ${a.status==='accepted'?'success':a.status==='rejected'?'warn':'info'}">${a.status||'pending'}</span></td><td data-label="Actions">${a.status==='pending'?'<button class="btn" data-app-act="accept" data-id="'+a.id+'">Accept</button> <button class="btn-ghost" data-app-act="reject" data-id="'+a.id+'">Reject</button>':''}</td>`;
        tbodyA.appendChild(row);
      });
    }
    document.querySelector('#ownerApps').addEventListener('click', async (e)=>{
      const act=e.target.getAttribute('data-app-act'); if(!act) return;
      const id=e.target.getAttribute('data-id');
      await updateApplicationStatus(id, act==='accept'?'accepted':'rejected');
      await renderOwnerApps();
    });
    await renderOwnerApps();
  }
});
</script>
<script>document.addEventListener('click',e=>{if(e.target?.id==='navToggle'){document.querySelector('.nav')?.classList.toggle('open')}if(e.target?.closest('.nav')&&e.target.tagName==='A'){document.querySelector('.nav')?.classList.remove('open')}});</script>
<script type="module">
import { onAuth, getUserDoc } from './js/offline.js';
onAuth(async (u)=>{
  const link=document.getElementById('navSuper'); if(!link) return;
  const you = u ? await getUserDoc(u.id||u) : null;
  link.style.display = (you && you.role==='super') ? 'inline-flex' : 'none';
});
</script>
</body></html>