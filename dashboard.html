<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<header class="container">
  <nav id="mainNav" class="nav">
    <a class="brand" href="index.html">FindMe</a>
    <button id="navToggle" class="nav-toggle" aria-label="Menu" aria-expanded="false" aria-controls="mainNav">☰</button>
    <div class="nav-items">
      <a class="chip" href="dashboard.html">Dashboard</a>
      <a class="chip" href="promoters.html" id="navPromoters">Promoters</a>
      <a class="chip" href="stores.html" id="navStores">Stores</a>
      <a class="chip" href="post_campaign.html" id="navPost">Post Campaign</a>
      <a class="chip" href="active_campaigns.html" id="navActive">Active Campaigns</a>
      <a class="chip" href="super.html" id="navSuper">Super</a>
      <a class="chip" href="signup.html" id="navCreate">Create account</a>
      <a class="chip" href="login.html" id="navLogin">Sign in</a>
      <span id="navUser" class="small"></span>
    </div>
  </nav>
</header>
<main class="container">

<div class="card">
  <h2>Dashboard</h2>
  <div id="roleNote" class="small"></div>
</div>
<div id="promoterBlock" class="card" style="display:none">
  <h3>Promoter dashboard</h3>
  <div id="gpsStatus" class="small" style="display:flex; gap:10px; align-items:center; margin:6px 0 10px 0">
    <button id="gpsStart" class="chip">Use GPS</button>
    <span id="gpsText">GPS: idle</span>
    <label class="small" style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" id="geoOverride"> Allow override</label>
    <select id="geoRadius" class="small"><option value="100">100 m</option><option value="150" selected>150 m</option><option value="250">250 m</option><option value="500">500 m</option></select>
  </div>
  <div id="mapPreview" class="card" style="padding:8px; margin-bottom:10px; display:none">
    <div class="small" style="margin-bottom:6px">Map preview (current vs store)</div>
    <img id="mapImg" alt="Map" style="width:100%; max-height:280px; object-fit:cover; border-radius:8px"/>
    <div class="small" id="mapNote" style="margin-top:6px"></div>
  </div>
  <h3>My Assignments</h3>
  <div class="table-wrap"><table class="table" id="myAssignmentsTable"><thead><tr><th>Store</th><th>Region</th><th>Campaign</th><th>Distance</th><th>Shift</th><th>Survey</th></tr></thead><tbody></tbody></table></div>
  <div class="card" id="timesheetCard" style="margin-top:14px">
    <h3>Timesheet</h3>
    <div style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;align-items:end">
      <label class="field"><span>From</span><input type="date" id="tsFrom"></label>
      <label class="field"><span>To</span><input type="date" id="tsTo"></label>
      <label class="field"><span>Export</span><button id="tsExport" class="btn-ghost">Download CSV</button></label>
      <div class="small" id="tsTotals" style="text-align:right;align-self:center"></div>
    </div>
    <div class="table-wrap" style="margin-top:10px"><table class="table" id="tsTable"><thead><tr><th>Date</th><th>Store</th><th>Campaign</th><th>Start</th><th>End</th><th>Hours</th><th>Pay (est)</th><th>StartLatLng</th><th>EndLatLng</th><th>DistanceStart(m)</th></tr></thead><tbody></tbody></table></div>
  </div>
  <div class="card" style="margin-top:14px">
    <h3>Invitations</h3>
    <div class="table-wrap"><table class="table" id="proInvitesTbl"><thead><tr><th>Campaign</th><th>Store</th><th>From</th><th>Status</th><th></th></tr></thead><tbody></tbody></table></div>
  </div>
</div>
<div id="companyBlock" class="card" style="display:none">
  <h3>Company dashboard</h3>
  <div class="card"><h3>Promoters</h3><div class="table-wrap"><table class="table" id="promotersTbl"><thead><tr><th>Name</th><th>Email</th></tr></thead><tbody></tbody></table></div></div>
  <div class="card" id="postCampaignCard"><h3>Post Campaign</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;align-items:end">
      <label class="field"><span>Title</span><input id="pcTitle"></label>
      <label class="field"><span>Rate/hr</span><input id="pcRate" type="number" value="80"></label>
      <label class="field"><span>Geofence radius (m)</span><input id="pcGeo" type="number" placeholder="e.g. 150"></label>
      <button class="btn" id="pcCreate">Create</button>
    </div>
  </div>
  <div class="card" id="activeCampaignsCard"><h3>Active Campaigns</h3><div class="table-wrap"><table class="table" id="activeTbl"><thead><tr><th>Title</th><th>Rate/hr</th><th>Geo</th><th>Status</th></tr></thead><tbody></tbody></table></div></div>
  <div class="card" id="linkAssignCard"><h3>Link Assignment (Campaign ↔ Store ↔ Promoter)</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:end">
      <label class="field"><span>Campaign</span><select id="selCampaign"></select></label>
      <label class="field"><span>Store</span><select id="selStore"></select></label>
      <label class="field"><span>Promoter</span><select id="selPromoter"></select></label>
      <button id="btnLink" class="btn">Link</button>
    </div>
    <div class="table-wrap" style="margin-top:12px"><table class="table" id="linksTable"><thead><tr><th>Campaign</th><th>Store</th><th>Promoter</th><th></th></tr></thead><tbody></tbody></table></div>
  </div>
  <div class="card" id="inviteCard"><h3>Invitations</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:end">
      <label class="field"><span>Promoter</span><select id="invPromoter"></select></label>
      <label class="field"><span>Campaign (optional)</span><select id="invCampaign"><option value="">—</option></select></label>
      <label class="field"><span>Store (optional)</span><select id="invStore"><option value="">—</option></select></label>
      <button class="btn" id="btnInvite">Send Invite</button>
    </div>
    <div class="table-wrap" style="margin-top:10px"><table class="table" id="ownerInvitesTbl"><thead><tr><th>Promoter</th><th>Campaign</th><th>Store</th><th>Status</th><th></th></tr></thead><tbody></tbody></table></div>
  </div>
  <div class="card" id="qBuilderCard"><h3>Campaign Questionnaires</h3>
    <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end"><label class="field"><span>Campaign</span><select id="qbCampaign"></select></label><button class="btn" id="qbNew">New Questionnaire</button></div>
    <div id="qbEditor" style="display:none; margin-top:10px">
      <label class="field"><span>Title</span><input id="qbTitle" placeholder="e.g. Launch Survey"></label>
      <div id="qbQuestions" class="small" style="margin-top:8px"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:6px;align-items:end;margin-top:8px">
        <input id="qbLabel" placeholder="Question label">
        <select id="qbType"><option value="text">Short text</option><option value="longtext">Long text</option><option value="number">Number</option><option value="yesno">Yes/No</option><option value="single">Single choice</option><option value="multi">Multiple choice</option><option value="rating">Rating (1-5)</option></select>
        <input id="qbOptions" placeholder="Options (comma-separated)">
        <label style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" id="qbReq"><span>Required</span></label>
        <button class="btn-ghost" id="qbAdd">Add question</button>
      </div>
      <div style="margin-top:8px"><button class="btn" id="qbSave">Save & Activate</button><button class="btn-ghost" id="qbCancel">Cancel</button></div>
    </div>
    <div class="table-wrap" style="margin-top:12px"><table class="table" id="qbList"><thead><tr><th>Title</th><th>Active</th><th>Created</th><th></th></tr></thead><tbody></tbody></table></div>
  </div>
</div>

<!-- Survey Modal -->
<div id="surveyModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9998; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:16px; border-radius:12px; width:min(720px, 96vw); max-height:85vh; overflow:auto;">
    <h3 id="svTitle" style="margin-top:0">Survey</h3>
    <form id="svForm" class="small"></form>
    <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end">
      <button class="btn-ghost" type="button" id="svCancel">Cancel</button>
      <button class="btn" type="submit" id="svSubmit">Submit</button>
    </div>
  </div>
</div>

<script type="module">
import {
  onAuth, currentUser,
  listPromoters, listCompanies, listStoresByOwner, listStoresForPromoter, createStore,
  listCampaignsByOwner, listCampaignsForPromoter, createCampaign,
  linkPromoterToCampaignStore, listLinksByOwner, unlinkLink,
  createInvite, listInvitesByOwner, listInvitesForPromoter, respondToInvite, revokeInvite,
  listQuestionnairesForCampaign, createQuestionnaire, setQuestionnaireActive, deleteQuestionnaire, submitResponse, listResponsesByQuestionnaire,
  startShift, endShift, listShiftsForPromoter, shiftDurationHours
} from './js/offline.js';

const ME = onAuth();
const roleNote = document.getElementById('roleNote');
if(ME){ roleNote.textContent = 'Signed in as ' + ME.email + ' (' + ME.role + ')'; }

document.getElementById('promoterBlock').style.display = (ME && ME.role==='promoter') ? 'block' : 'none';
document.getElementById('companyBlock').style.display = (ME && ME.role==='company') ? 'block' : 'none';

// PROMOTER
if(ME && ME.role==='promoter'){
  let loc = window.__fmLoc || { lat:null, lng:null, accuracy:null, ts:null }; window.__fmLoc = loc;
  const gpsText=document.getElementById('gpsText'), gpsStart=document.getElementById('gpsStart');
  function setGpsText(t){ if(gpsText) gpsText.textContent=t; }
  function startGPS(){ if(!('geolocation' in navigator)){ setGpsText('GPS not supported'); return; } setGpsText('GPS: requesting…'); try{
    const id = navigator.geolocation.watchPosition(function(pos){ loc.lat=pos.coords.latitude; loc.lng=pos.coords.longitude; loc.accuracy=pos.coords.accuracy; loc.ts=Date.now(); setGpsText('GPS: '+loc.lat.toFixed(5)+','+loc.lng.toFixed(5)+' ±'+Math.round(loc.accuracy)+'m'); }, function(err){ setGpsText('GPS error: '+err.message); }, { enableHighAccuracy:true, timeout:10000, maximumAge:2000 });
    window.__fmGpsWatchId = id;
  }catch(e){ setGpsText('GPS error'); } }
  gpsStart.addEventListener('click', startGPS); startGPS();

  const mapBox=document.getElementById('mapPreview'); const mapImg=document.getElementById('mapImg'); const mapNote=document.getElementById('mapNote');
  function staticMapURL({lat1,lng1,lat2,lng2}){ const p=new URLSearchParams({ center: String(lat2||lat1)+','+String(lng2||lng1), zoom:'15', size:'640x280', markers:[lat1&&lng1?(lat1+','+lng1+',blue'):'', lat2&&lng2?(lat2+','+lng2+',red'):''].filter(Boolean).join('|') }); return 'https://staticmap.openstreetmap.de/staticmap.php?'+p.toString(); }
  function showMap(cur, store){ if(!mapBox||!mapImg) return; if(!cur||cur.lat==null||cur.lng==null||!store||store.lat==null||store.lng==null){ mapBox.style.display='none'; return; } mapImg.src=staticMapURL({lat1:cur.lat,lng1:cur.lng,lat2:store.lat,lng2:store.lng}); mapBox.style.display='block'; mapNote.textContent='You (blue) → Store (red) — acc ±'+(cur.accuracy?Math.round(cur.accuracy):'?')+'m'; }
  function haversine(a,b,c,d){ if([a,b,c,d].some(v=>v==null)) return Infinity; const R=6371000,toR=x=>x*Math.PI/180; const dLa=toR(c-a), dLo=toR(d-b); const A=Math.sin(dLa/2)**2+Math.cos(toR(a))*Math.cos(toR(c))*Math.sin(dLo/2)**2; return 2*R*Math.asin(Math.sqrt(A)); }

  const tbody=document.querySelector('#myAssignmentsTable tbody');
  const stores=await listStoresForPromoter(ME.id); const camps=await listCampaignsForPromoter(ME.id);
  const linkArr = (JSON.parse(localStorage.getItem('fm_links')||'[]')).filter(l=>l.promoterId===ME.id);
  const campBy = Object.fromEntries(camps.map(c=>[c.id,c])); const storeBy=Object.fromEntries(stores.map(s=>[s.id,s]));

  tbody.innerHTML='';
  for(const l of linkArr){ const c=campBy[l.campaignId], s=storeBy[l.storeId]; const dist=haversine(loc.lat,loc.lng,s.lat,s.lng); const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.name}</td><td>${s.region||'-'}</td><td>${c.title}</td><td>${isFinite(dist)?Math.round(dist)+' m':'—'}</td>
                  <td><button class="btn" data-start="${s.id}" data-camp="${c.id}">Start</button> <button class="btn-ghost" data-end="${s.id}">End</button></td><td class="surveyCell">-</td>`; tbody.appendChild(tr);
  }
  const rows=[...linkArr].map(l=>({campaign:campBy[l.campaignId], store:storeBy[l.storeId]})); const qByCamp={};
  for(const r of rows){ const forms=await listQuestionnairesForCampaign(r.campaign.id); qByCamp[r.campaign.id]=forms.find(f=>f.active)||null; }
  Array.from(tbody.querySelectorAll('tr')).forEach((tr,idx)=>{ const camp=rows[idx].campaign; const f=qByCamp[camp.id]; const cell=tr.querySelector('.surveyCell'); if(f){ cell.innerHTML = `<button class="btn-ghost" data-survey="${f.id}" data-camp="${camp.id}">Fill</button>`; } });

  const modal=document.getElementById('surveyModal'), svForm=document.getElementById('svForm'), svTitle=document.getElementById('svTitle'), svCancel=document.getElementById('svCancel');
  function openModal(){ modal.style.display='flex'; } function closeModal(){ modal.style.display='none'; svForm.innerHTML=''; }
  tbody.addEventListener('click', async (e)=>{
    const qid = e.target.getAttribute && e.target.getAttribute('data-survey'); const campId = e.target.getAttribute && e.target.getAttribute('data-camp'); if(!qid) return;
    const forms = await listQuestionnairesForCampaign(campId); const form=forms.find(f=>f.id===qid); if(!form){ toast('Form not found', false); return; }
    svTitle.textContent = form.title||'Survey'; svForm.innerHTML = '';
    form.questions.forEach(q=>{ const wrap=document.createElement('div'); wrap.style.marginBottom='8px'; const lab=document.createElement('div'); lab.innerHTML=`<b>${q.label}</b> ${q.required?'<span class="small" style="color:#b00">(required)</span>':''}`; wrap.appendChild(lab); let el=null;
      if(q.type==='text'){ el=document.createElement('input'); el.type='text'; el.name=q.id; el.className='input'; }
      else if(q.type==='longtext'){ el=document.createElement('textarea'); el.name=q.id; el.rows=3; el.className='input'; }
      else if(q.type==='number'){ el=document.createElement('input'); el.type='number'; el.name=q.id; el.className='input'; }
      else if(q.type==='yesno'){ el=document.createElement('select'); el.name=q.id; el.innerHTML='<option value=\"\">—</option><option value=\"Yes\">Yes</option><option value=\"No\">No</option>'; }
      else if(q.type==='single'){ el=document.createElement('select'); el.name=q.id; el.innerHTML='<option value=\"\">—</option>'+(q.options||[]).map(o=>`<option value=\"${o}\">${o}</option>`).join(''); }
      else if(q.type==='multi'){ el=document.createElement('div'); (q.options||[]).forEach(o=>{ const line=document.createElement('label'); line.style.display='inline-flex'; line.style.gap='6px'; line.style.marginRight='10px'; line.style.alignItems='center'; line.innerHTML = `<input type=\"checkbox\" name=\"${q.id}\" value=\"${o}\"><span>${o}</span>`; el.appendChild(line); }); }
      else if(q.type==='rating'){ el=document.createElement('select'); el.name=q.id; el.innerHTML='<option value=\"\">—</option>'+[1,2,3,4,5].map(n=>`<option value=\"${n}\">${n}</option>`).join(''); }
      else { el=document.createElement('input'); el.type='text'; el.name=q.id; }
      wrap.appendChild(el); svForm.appendChild(wrap);
    });
    openModal();
    svForm.onsubmit = async (ev)=>{ ev.preventDefault(); try{
      const answers=[]; for(const q of form.questions){ let v=null; if(q.type==='multi'){ v=[...svForm.querySelectorAll(`input[name=\"${q.id}\"]:checked`)].map(x=>x.value); } else { const el=svForm.querySelector(`[name=\"${q.id}\"]`); v=el?el.value:null; }
        if(q.required){ if((q.type==='multi' && (!v || v.length===0)) || (q.type!=='multi' && (!v || (''+v).trim()===''))){ toast('Answer required', false); return; } }
        answers.push({ qid:q.id, value:v });
      }
      await submitResponse({questionnaireId: form.id, campaignId: campId, promoterId: ME.id, answers}); toast('Responses submitted ✓'); closeModal();
    }catch(err){ toast(err.message||'Submit failed', false); } };
  });
  if(svCancel) svCancel.onclick = closeModal;

  tbody.addEventListener('click', async (e)=>{
    const startId = e.target.getAttribute && e.target.getAttribute('data-start');
    const endId = e.target.getAttribute && e.target.getAttribute('data-end');
    function haversine(a,b,c,d){ if([a,b,c,d].some(v=>v==null)) return Infinity; const R=6371000,toR=x=>x*Math.PI/180; const dLa=toR(c-a), dLo=toR(d-b); const A=Math.sin(dLa/2)**2+Math.cos(toR(a))*Math.cos(toR(c))*Math.sin(dLo/2)**2; return 2*R*Math.asin(Math.sqrt(A)); }
    if(startId){
      const stores=await listStoresForPromoter(ME.id); const s=stores.find(x=>x.id===startId)||{};
      const camps=await listCampaignsForPromoter(ME.id); const camp=camps.find(x=> String(x.id)===String(e.target.getAttribute('data-camp')))||{};
      const uiRadius = Number((document.getElementById('geoRadius')||{}).value)||150;
      const radius = Number(s.geoRadius||camp.geoRadius||uiRadius||150);
      const allowOverride = !!((document.getElementById('geoOverride')||{}).checked);
      const dist = haversine(loc.lat,loc.lng,s.lat,s.lng);
      showMap(loc, s);
      if(!(allowOverride || (isFinite(dist) && dist <= radius))){ toast('Too far: '+(isFinite(dist)?Math.round(dist):'unknown')+' m (limit '+radius+' m)', false); return; }
      const rec = startShift({ promoterId: ME.id, storeId: s.id, campaignId: camp.id, startLoc: loc }); toast('Shift started ✓'); localStorage.setItem('fm_lastShiftId', rec.id);
    }
    if(endId){ const lastId = localStorage.getItem('fm_lastShiftId'); try{ if(lastId){ endShift({ shiftId:lastId, endLoc:loc }); toast('Shift ended ✓'); } else { toast('No active shift found', false); } }catch(err){ toast(err.message||'End failed', false); } }
  }, true);

  async function renderTimesheet(){
    function haversine(a,b,c,d){ if([a,b,c,d].some(v=>v==null)) return Infinity; const R=6371000,toR=x=>x*Math.PI/180; const dLa=toR(c-a), dLo=toR(d-b); const A=Math.sin(dLa/2)**2+Math.cos(toR(a))*Math.cos(toR(c))*Math.sin(dLo/2)**2; return 2*R*Math.asin(Math.sqrt(A)); }
    const from=(document.getElementById('tsFrom')||{}).value||null, to=(document.getElementById('tsTo')||{}).value||null;
    const shifts=await listShiftsForPromoter(ME.id,{from,to});
    const stores=await listStoresForPromoter(ME.id); const storeBy={}; stores.forEach(s=>storeBy[s.id]=s);
    const camps=await listCampaignsForPromoter(ME.id); const campBy={}; camps.forEach(c=>campBy[c.id]=c);
    const tb=document.querySelector('#tsTable tbody'); tb.innerHTML=''; let totalH=0,totalPay=0;
    shifts.forEach(s=>{ const st=new Date(s.startAt), et=s.endAt?new Date(s.endAt):null; const hrs=shiftDurationHours(s); totalH+=hrs;
      const store=storeBy[s.storeId]||{}; const camp=campBy[s.campaignId]||{}; const rate=camp.ratePerHour||0; const pay=+(hrs*rate).toFixed(2); totalPay+=pay;
      const dStart = (s.startLoc && store.lat!=null) ? Math.round(haversine(s.startLoc.lat,s.startLoc.lng, store.lat, store.lng)) : '';
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${st.toISOString().slice(0,10)}</td><td>${store.name||''}</td><td>${camp.title||''}</td>
        <td>${st.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</td><td>${et?et.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}):''}</td>
        <td>${hrs.toFixed(2)}</td><td>${pay.toFixed(2)}</td>
        <td>${s.startLoc&&s.startLoc.lat!=null?(s.startLoc.lat.toFixed(5)+','+s.startLoc.lng.toFixed(5)):''}</td><td>${s.endLoc&&s.endLoc.lat!=null?(s.endLoc.lat.toFixed(5)+','+s.endLoc.lng.toFixed(5)):''}</td><td>${dStart}</td>`; tb.appendChild(tr);
    });
    const totals=document.getElementById('tsTotals'); if(totals){ totals.textContent='Total: '+totalH.toFixed(2)+' hrs — '+totalPay.toFixed(2); }
  }
  document.getElementById('tsFrom').addEventListener('change', renderTimesheet);
  document.getElementById('tsTo').addEventListener('change', renderTimesheet);
  document.getElementById('tsExport').addEventListener('click', async ()=>{
    function haversine(a,b,c,d){ if([a,b,c,d].some(v=>v==null)) return Infinity; const R=6371000,toR=x=>x*Math.PI/180; const dLa=toR(c-a), dLo=toR(d-b); const A=Math.sin(dLa/2)**2+Math.cos(toR(a))*Math.cos(toR(c))*Math.sin(dLo/2)**2; return 2*R*Math.asin(Math.sqrt(A)); }
    const shifts=await listShiftsForPromoter(ME.id,{}); const stores=await listStoresForPromoter(ME.id); const camps=await listCampaignsForPromoter(ME.id);
    const sBy=Object.fromEntries(stores.map(s=>[s.id,s])); const cBy=Object.fromEntries(camps.map(c=>[c.id,c]));
    const rows=[['Date','Store','Campaign','Start','End','Hours','Rate','Pay','StartLatLng','EndLatLng','DistanceStart(m)']];
    shifts.forEach(s=>{ const st=new Date(s.startAt), et=s.endAt?new Date(s.endAt):null; const hrs=shiftDurationHours(s); const store=sBy[s.storeId]||{}; const camp=cBy[s.campaignId]||{}; const rate=camp.ratePerHour||0; const pay=+(hrs*rate).toFixed(2);
      const dStart = (s.startLoc && store.lat!=null) ? Math.round(haversine(s.startLoc.lat,s.startLoc.lng, store.lat, store.lng)) : '';
      rows.push([st.toISOString().slice(0,10), store.name||'', camp.title||'', st.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}), et?et.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}):'', hrs.toFixed(2), rate, pay.toFixed(2),
        (s.startLoc && s.startLoc.lat!=null)?(s.startLoc.lat+','+s.startLoc.lng):'', (s.endLoc && s.endLoc.lat!=null)?(s.endLoc.lat+','+s.endLoc.lng):'', dStart]); });
    const csv = rows.map(r=>r.map(v=>(''+v).replace(/"/g,'""')).map(v=>`"${v}"`).join(',')).join('\\n'); const url=URL.createObjectURL(new Blob([csv], {type:'text/csv'})); const a=document.createElement('a'); a.href=url; a.download='timesheet.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),4000);
  });
  await renderTimesheet();

  async function renderProInvites(){ const rows=await listInvitesForPromoter(ME.id); const tb=document.querySelector('#proInvitesTbl tbody'); tb.innerHTML='';
    const owners=await listCompanies(); const camps=await listCampaignsForPromoter(ME.id); const stores=await listStoresForPromoter(ME.id); const by=(arr)=>Object.fromEntries(arr.map(x=>[x.id,x])); const campBy=by(camps), storeBy=by(stores), ownerBy=by(owners);
    rows.forEach(r=>{ const c=campBy[r.campaignId]||{}; const s=storeBy[r.storeId]||{}; const o=ownerBy[r.ownerId]||{}; const tr=document.createElement('tr');
      tr.innerHTML = `<td>${c.title||'-'}</td><td>${s.name||'-'}</td><td>${o.companyName||o.email||'-'}</td><td>${r.status}</td><td style="text-align:right">${r.status==='pending'?`<button class="btn" data-acc="${r.id}">Accept</button> <button class="btn-ghost" data-dec="${r.id}">Decline</button>`:''}</td>`; tb.appendChild(tr); });
  }
  await renderProInvites();
  document.getElementById('proInvitesTbl').addEventListener('click', async (e)=>{ const acc=e.target.getAttribute&&e.target.getAttribute('data-acc'); const dec=e.target.getAttribute&&e.target.getAttribute('data-dec'); if(!acc&&!dec) return;
    try{ await respondToInvite({inviteId:(acc||dec), action: acc?'accept':'decline'}); toast(acc?'Invite accepted ✓':'Invite declined'); await renderProInvites(); }catch(err){ toast(err.message||'Failed', false); }
  });
}

// COMPANY
if(ME && ME.role==='company'){
  const promos=await listPromoters(); const ptb=document.querySelector('#promotersTbl tbody'); ptb.innerHTML=''; promos.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${((p.firstName||'')+' '+(p.surname||'')).trim()||'-'}</td><td>${p.email}</td>`; ptb.appendChild(tr); });
  const qbCamp=document.getElementById('qbCampaign'); const campsOwn=await listCampaignsByOwner(ME.id);
  function refreshActive(){ const tb=document.querySelector('#activeTbl tbody'); tb.innerHTML=''; campsOwn.forEach(c=>{ if(c.status!=='active') return; const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.title}</td><td>${c.ratePerHour||0}</td><td>${c.geoRadius||'-'}</td><td>${c.status}</td>`; tb.appendChild(tr); }); }
  refreshActive(); if(qbCamp){ qbCamp.innerHTML=''; campsOwn.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.title; qbCamp.appendChild(o); }); }
  document.getElementById('pcCreate').onclick = async ()=>{ const title=document.getElementById('pcTitle').value.trim(); const rate=Number(document.getElementById('pcRate').value)||0; const geo=Number(document.getElementById('pcGeo').value)||null;
    if(!title){ toast('Enter title', false); return; } const c=createCampaign({ownerId:ME.id,title,ratePerHour:rate,geoRadius:geo,status:'active'}); campsOwn.push(c); toast('Campaign created ✓'); document.getElementById('pcTitle').value=''; refreshActive(); if(qbCamp){ const o=document.createElement('option'); o.value=c.id; o.textContent=c.title; qbCamp.appendChild(o); } };
  const [stores, promos2] = [await listStoresByOwner(ME.id), await listPromoters()];
  const by=(arr,f,id)=>{ const el=document.getElementById(id); if(!el) return; el.innerHTML=''; arr.forEach(x=>{ const o=document.createElement('option'); o.value=x.id; o.textContent=f(x); el.appendChild(o); }); };
  by(campsOwn, c=>c.title, 'selCampaign'); by(stores, s=>s.name, 'selStore'); by(promos2, p=>(((p.firstName||'')+' '+(p.surname||'')).trim()||p.email), 'selPromoter');
  document.getElementById('btnLink').onclick = async ()=>{ const campaignId=(document.getElementById('selCampaign')||{}).value; const storeId=(document.getElementById('selStore')||{}).value; const promoterId=(document.getElementById('selPromoter')||{}).value;
    if(!campaignId||!storeId||!promoterId){ toast('Select all', false); return; } linkPromoterToCampaignStore({campaignId,storeId,promoterId}); toast('Linked ✓'); await renderLinks(); };
  async function renderLinks(){ const rows=await listLinksByOwner(ME.id); const tb=document.querySelector('#linksTable tbody'); tb.innerHTML=''; rows.forEach(r=>{ const p=r.promoter?((((r.promoter.firstName||'')+' '+(r.promoter.surname||'')).trim())||r.promoter.email):'(unknown)'; const tr=document.createElement('tr'); tr.innerHTML = `<td>${r.campaign.title}</td><td>${r.store.name}</td><td>${p}</td><td style="text-align:right"><button class="btn-ghost" data-del="${r.id}">Unlink</button></td>`; tb.appendChild(tr); }); }
  await renderLinks();
  document.getElementById('linksTable').addEventListener('click', async (e)=>{ const id=e.target.getAttribute && e.target.getAttribute('data-del'); if(!id) return; unlinkLink(id); toast('Unlinked'); await renderLinks(); });
  const setSel=(id,arr,lab)=>{ const el=document.getElementById(id); if(!el) return; el.innerHTML = id!=='invPromoter' ? '<option value=\"\">—</option>' : ''; arr.forEach(x=>{ const o=document.createElement('option'); o.value=x.id; o.textContent=lab(x); el.appendChild(o); }); };
  setSel('invPromoter', promos2, p=>(((p.firstName||'')+' '+(p.surname||'')).trim()||p.email)); setSel('invCampaign', campsOwn, c=>c.title); setSel('invStore', stores, s=>s.name);
  document.getElementById('btnInvite').onclick = async ()=>{ const promoterId=(document.getElementById('invPromoter')||{}).value; const campaignId=(document.getElementById('invCampaign')||{}).value||null; const storeId=(document.getElementById('invStore')||{}).value||null;
    if(!promoterId){ toast('Choose promoter', false); return; } createInvite({ownerId:ME.id,promoterId,campaignId,storeId}); toast('Invite sent ✓'); await renderOwnerInvites(); };
  async function renderOwnerInvites(){ const rows=await listInvitesByOwner(ME.id); const tb=document.querySelector('#ownerInvitesTbl tbody'); tb.innerHTML=''; rows.forEach(r=>{ const p=promos2.find(x=>x.id===r.promoterId)||{}; const c=campsOwn.find(x=>x.id===r.campaignId)||{}; const s=stores.find(x=>x.id===r.storeId)||{}; const tr=document.createElement('tr'); tr.innerHTML = `<td>${(((p.firstName||'')+' '+(p.surname||'')).trim()||p.email)}</td><td>${c.title||'-'}</td><td>${s.name||'-'}</td><td>${r.status}</td><td style="text-align:right">${r.status==='pending'?`<button class="btn-ghost" data-revoke="${r.id}">Revoke</button>`:''}</td>`; tb.appendChild(tr); }); }
  await renderOwnerInvites();
  document.getElementById('ownerInvitesTbl').addEventListener('click', async (e)=>{ const id=e.target.getAttribute && e.target.getAttribute('data-revoke'); if(!id) return; revokeInvite(id); toast('Invite revoked'); await renderOwnerInvites(); });
  const qbNew=document.getElementById('qbNew'), qbEditor=document.getElementById('qbEditor'), qbTitle=document.getElementById('qbTitle'), qbQ=document.getElementById('qbQuestions'), qbAdd=document.getElementById('qbAdd'), qbLabel=document.getElementById('qbLabel'), qbType=document.getElementById('qbType'), qbOptions=document.getElementById('qbOptions'), qbReq=document.getElementById('qbReq'), qbSave=document.getElementById('qbSave'), qbCancel=document.getElementById('qbCancel'), qbList=document.getElementById('qbList');
  let qbBuf=[]; function renderQBuf(){ qbQ.innerHTML=''; qbBuf.forEach((q,i)=>{ const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr auto'; row.style.gap='6px'; row.style.alignItems='center'; row.innerHTML=`<div><b>${i+1}.</b> ${q.label} <span class="small">[${q.type}${q.required?'; req':''}] ${q.options&&q.options.length?(' – '+q.options.join('/')):''}</span></div><button class="btn-ghost" data-del="${i}">Remove</button>`; qbQ.appendChild(row); }); }
  if(qbNew){ qbNew.onclick=()=>{ qbEditor.style.display='block'; qbTitle.value=''; qbBuf=[]; renderQBuf(); }; }
  if(qbCancel){ qbCancel.onclick=()=>{ qbEditor.style.display='none'; qbBuf=[]; }; }
  if(qbAdd){ qbAdd.onclick=()=>{ const label=(qbLabel.value||'').trim(); if(!label){ toast('Enter a label', false); return; } const type=qbType.value; const opts=(qbOptions.value||'').split(',').map(s=>s.trim()).filter(Boolean); qbBuf.push({ label, type, options:(type==='single'||type==='multi')?opts:[], required:!!qbReq.checked }); qbLabel.value=''; qbOptions.value=''; qbReq.checked=false; renderQBuf(); }; }
  if(qbSave){ qbSave.onclick=async()=>{ const campaignId=(document.getElementById('qbCampaign')||{}).value; if(!campaignId){ toast('Choose campaign', false); return; } if(qbBuf.length===0){ toast('Add at least one question', false); return; } const q=createQuestionnaire({ownerId:ME.id,campaignId,title:qbTitle.value||null,questions:qbBuf,active:true}); toast('Saved & activated ✓'); qbEditor.style.display='none'; qbBuf=[]; await renderQList(); }; }
  async function renderQList(){ const campaignId=(document.getElementById('qbCampaign')||{}).value; if(!campaignId) return; const rows=await listQuestionnairesForCampaign(campaignId); const tb=qbList.querySelector('tbody'); tb.innerHTML=''; rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.title||'-'}</td><td>${r.active?'Yes':'No'}</td><td>${new Date(r.createdAt).toLocaleString()}</td><td style="text-align:right"><button class="btn-ghost" data-activate="${r.id}">Activate</button> <button class="btn-ghost" data-export="${r.id}">Export CSV</button> <button class="btn-ghost" data-delete="${r.id}">Delete</button></td>`; tb.appendChild(tr); }); }
  await renderQList(); document.getElementById('qbCampaign').addEventListener('change', renderQList);
  qbList.addEventListener('click', async (e)=>{
    const act=e.target.getAttribute && e.target.getAttribute('data-activate');
    const exp=e.target.getAttribute && e.target.getAttribute('data-export');
    const del=e.target.getAttribute && e.target.getAttribute('data-delete');
    if(act){ setQuestionnaireActive(act, true); toast('Activated ✓'); await renderQList(); return; }
    if(del){ deleteQuestionnaire(del); toast('Deleted'); await renderQList(); return; }
    if(exp){
      const campaignId=(document.getElementById('qbCampaign')||{}).value;
      const forms=await listQuestionnairesForCampaign(campaignId); const form=forms.find(f=>f.id===exp); if(!form){ toast('Form not found', false); return; }
      const resps=await listResponsesByQuestionnaire(form.id); const promoters=await listPromoters(); const promBy=Object.fromEntries(promoters.map(p=>[p.id,p]));
      const header=['Promoter','Email','Submitted At', ...form.questions.map(q=>q.label)]; const rows=[header];
      resps.forEach(r=>{ const p=promBy[r.promoterId]||{}; const name=(((p.firstName||'')+' '+(p.surname||'')).trim())||p.email||p.id; const email=p.email||''; const ansMap={}; (r.answers||[]).forEach(a=>ansMap[a.qid]=a.value); const vals=form.questions.map(q=>{ const v=ansMap[q.id]; if(v==null) return ''; if(Array.isArray(v)) return v.join('; '); return ''+v; }); rows.push([name, email, new Date(r.submittedAt).toLocaleString(), ...vals]); });
      const csv = rows.map(r=>r.map(v=>(''+v).replace(/"/g,'""')).map(v=>`"${v}"`).join(',')).join('\\n');
      const url=URL.createObjectURL(new Blob([csv], {type:'text/csv'})); const a=document.createElement('a'); a.href=url; a.download=(form.title||'questionnaire')+'_responses.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),4000);
    }
  });
}
</script>

</main>
<div id="toast" class="toast"></div>
<script>(function(){var nav=document.getElementById('mainNav'),btn=document.getElementById('navToggle');if(!nav||!btn)return;function t(){var o=nav.classList.toggle('open');btn.setAttribute('aria-expanded',o?'true':'false')}function c(){nav.classList.remove('open');btn.setAttribute('aria-expanded','false')}if(!btn.dataset.bnd){btn.dataset.bnd='1';btn.addEventListener('click',t)}var items=nav.querySelector('.nav-items');if(items&&!items.dataset.bnd){items.dataset.bnd='1';items.addEventListener('click',function(e){if(e.target.tagName==='A'||(e.target.closest&&e.target.closest('a'))){c()}})}})();function toast(m,o){o=o!==false;var el=document.getElementById('toast');if(!el)return;el.textContent=m;el.style.background=o?'#111':'#b00';el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1600);}</script>
<script type="module">import { onAuth } from './js/offline.js'; onAuth();</script>
</body></html>