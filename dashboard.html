<
!
d
o
c
t
y
p
e
 
h
t
m
l
>


<
h
t
m
l
>


<
h
e
a
d
>


<
m
e
t
a
 
c
h
a
r
s
e
t
=
"
u
t
f
-
8
"
>
<
m
e
t
a
 
n
a
m
e
=
"
v
i
e
w
p
o
r
t
"
 
c
o
n
t
e
n
t
=
"
w
i
d
t
h
=
d
e
v
i
c
e
-
w
i
d
t
h
,
 
i
n
i
t
i
a
l
-
s
c
a
l
e
=
1
"
>


<
t
i
t
l
e
>
D
a
s
h
b
o
a
r
d
<
/
t
i
t
l
e
>


<
l
i
n
k
 
r
e
l
=
"
s
t
y
l
e
s
h
e
e
t
"
 
h
r
e
f
=
"
c
s
s
/
s
t
y
l
e
.
c
s
s
"
>


<
/
h
e
a
d
>


<
b
o
d
y
>


<
h
e
a
d
e
r
 
c
l
a
s
s
=
"
c
o
n
t
a
i
n
e
r
"
>


 
 
<
n
a
v
 
i
d
=
"
m
a
i
n
N
a
v
"
 
c
l
a
s
s
=
"
n
a
v
"
>


 
 
 
 
<
a
 
c
l
a
s
s
=
"
b
r
a
n
d
"
 
h
r
e
f
=
"
i
n
d
e
x
.
h
t
m
l
"
>
F
i
n
d
M
e
<
/
a
>


 
 
 
 
<
b
u
t
t
o
n
 
i
d
=
"
n
a
v
T
o
g
g
l
e
"
 
c
l
a
s
s
=
"
n
a
v
-
t
o
g
g
l
e
"
 
a
r
i
a
-
l
a
b
e
l
=
"
M
e
n
u
"
 
a
r
i
a
-
e
x
p
a
n
d
e
d
=
"
f
a
l
s
e
"
 
a
r
i
a
-
c
o
n
t
r
o
l
s
=
"
m
a
i
n
N
a
v
"
>
☰
<
/
b
u
t
t
o
n
>


 
 
 
 
<
d
i
v
 
c
l
a
s
s
=
"
n
a
v
-
i
t
e
m
s
"
>


 
 
 
 
 
 
<
a
 
c
l
a
s
s
=
"
c
h
i
p
"
 
h
r
e
f
=
"
d
a
s
h
b
o
a
r
d
.
h
t
m
l
"
>
D
a
s
h
b
o
a
r
d
<
/
a
>


 
 
 
 
 
 
<
a
 
c
l
a
s
s
=
"
c
h
i
p
"
 
h
r
e
f
=
"
p
r
o
m
o
t
e
r
s
.
h
t
m
l
"
 
i
d
=
"
n
a
v
P
r
o
m
o
t
e
r
s
"
>
P
r
o
m
o
t
e
r
s
<
/
a
>


 
 
 
 
 
 
<
a
 
c
l
a
s
s
=
"
c
h
i
p
"
 
h
r
e
f
=
"
s
t
o
r
e
s
.
h
t
m
l
"
 
i
d
=
"
n
a
v
S
t
o
r
e
s
"
>
S
t
o
r
e
s
<
/
a
>


 
 
 
 
 
 
<
a
 
c
l
a
s
s
=
"
c
h
i
p
"
 
h
r
e
f
=
"
p
o
s
t
_
c
a
m
p
a
i
g
n
.
h
t
m
l
"
 
i
d
=
"
n
a
v
P
o
s
t
"
>
P
o
s
t
 
C
a
m
p
a
i
g
n
<
/
a
>


 
 
 
 
 
 
<
a
 
c
l
a
s
s
=
"
c
h
i
p
"
 
h
r
e
f
=
"
a
c
t
i
v
e
_
c
a
m
p
a
i
g
n
s
.
h
t
m
l
"
 
i
d
=
"
n
a
v
A
c
t
i
v
e
"
>
A
c
t
i
v
e
 
C
a
m
p
a
i
g
n
s
<
/
a
>


 
 
 
 
 
 
<
a
 
c
l
a
s
s
=
"
c
h
i
p
"
 
h
r
e
f
=
"
s
u
p
e
r
.
h
t
m
l
"
 
i
d
=
"
n
a
v
S
u
p
e
r
"
>
S
u
p
e
r
<
/
a
>


 
 
 
 
 
 
<
a
 
c
l
a
s
s
=
"
c
h
i
p
"
 
h
r
e
f
=
"
s
i
g
n
u
p
.
h
t
m
l
"
 
i
d
=
"
n
a
v
C
r
e
a
t
e
"
>
C
r
e
a
t
e
 
a
c
c
o
u
n
t
<
/
a
>


 
 
 
 
 
 
<
a
 
c
l
a
s
s
=
"
c
h
i
p
"
 
h
r
e
f
=
"
l
o
g
i
n
.
h
t
m
l
"
 
i
d
=
"
n
a
v
L
o
g
i
n
"
>
S
i
g
n
 
i
n
<
/
a
>


 
 
 
 
 
 
<
b
u
t
t
o
n
 
c
l
a
s
s
=
"
c
h
i
p
"
 
i
d
=
"
n
a
v
R
e
s
e
t
"
 
t
i
t
l
e
=
"
R
e
s
e
t
 
d
e
m
o
 
d
a
t
a
"
>
R
e
s
e
t
<
/
b
u
t
t
o
n
>


 
 
 
 
 
 
<
s
p
a
n
 
i
d
=
"
n
a
v
U
s
e
r
"
 
c
l
a
s
s
=
"
s
m
a
l
l
"
>
<
/
s
p
a
n
>


 
 
 
 
<
/
d
i
v
>


 
 
<
/
n
a
v
>


<
/
h
e
a
d
e
r
>


<
m
a
i
n
 
c
l
a
s
s
=
"
c
o
n
t
a
i
n
e
r
"
>


<
d
i
v
 
i
d
=
"
c
t
x
W
a
r
n
"
 
c
l
a
s
s
=
"
w
a
r
n
"
 
s
t
y
l
e
=
"
d
i
s
p
l
a
y
:
n
o
n
e
"
>
G
e
o
l
o
c
a
t
i
o
n
 
m
u
s
t
 
r
u
n
 
o
n
 
<
b
>
h
t
t
p
:
/
/
l
o
c
a
l
h
o
s
t
<
/
b
>
 
o
r
 
H
T
T
P
S
.
 
I
f
 
y
o
u
 
o
p
e
n
e
d
 
f
i
l
e
s
 
d
i
r
e
c
t
l
y
,
 
p
l
e
a
s
e
 
s
t
a
r
t
 
a
 
l
o
c
a
l
 
s
e
r
v
e
r
.
<
/
d
i
v
>


<
s
c
r
i
p
t
>
i
f
(
l
o
c
a
t
i
o
n
.
p
r
o
t
o
c
o
l
=
=
=
'
f
i
l
e
:
'
)
{
d
o
c
u
m
e
n
t
.
g
e
t
E
l
e
m
e
n
t
B
y
I
d
(
'
c
t
x
W
a
r
n
'
)
.
s
t
y
l
e
.
d
i
s
p
l
a
y
=
'
b
l
o
c
k
'
}
<
/
s
c
r
i
p
t
>


<
s
c
r
i
p
t
 
s
r
c
=
"
j
s
/
a
p
p
.
j
s
"
>
<
/
s
c
r
i
p
t
>


<
s
c
r
i
p
t
>
F
M
.
o
n
A
u
t
h
(
)
;
<
/
s
c
r
i
p
t
>
<div class="card"><h2>Dashboard</h2><div id="roleNote" class="small"></div></div>
<div id="proBlock" class="card" style="display:none">
  <h3>My assigned stores</h3>
  <div class="table-wrap"><table class="table" id="assignTbl"><thead><tr><th>Store</th><th>Region</th><th>Campaign</th><th>Distance</th><th></th></tr></thead><tbody></tbody></table></div>
  <div id="gpsBar" class="small" style="display:flex;gap:10px;align-items:center;margin-top:6px">
    <button id="gpsBtn" class="chip">Use GPS</button><span id="gpsText">GPS: idle</span>
    <label class="small" style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" id="geoOverride"> Allow override</label>
    <select id="geoRadius" class="small"><option value="100">100 m</option><option value="150" selected>150 m</option><option value="250">250 m</option><option value="500">500 m</option></select>
  </div>
  <div id="mapBox" class="card" style="padding:8px;display:none">
    <div class="small" style="margin-bottom:6px">Map preview (you vs store)</div>
    <img id="mapImg" style="width:100%;max-height:280px;object-fit:cover;border-radius:8px">
    <div id="mapNote" class="small" style="margin-top:6px"></div>
  </div>
</div>
<script>
const ME = FM.currentUser(); FM.onAuth();
document.getElementById('proBlock').style.display = (ME && ME.role==='promoter') ? 'block' : 'none';
const roleNote = document.getElementById('roleNote'); if(ME){ roleNote.textContent='Signed in as '+ME.email+' ('+ME.role+')'; }
let loc = {lat:null,lng:null,accuracy:null,ts:null};
const gpsBtn=document.getElementById('gpsBtn'), gpsText=document.getElementById('gpsText');
function setGpsText(t){ if(gpsText) gpsText.textContent=t; }
function startGPS(){
  if(!('geolocation' in navigator)){ setGpsText('GPS not supported'); return; }
  setGpsText('GPS: requesting…');
  try{
    navigator.geolocation.watchPosition(function(pos){
      loc.lat=pos.coords.latitude; loc.lng=pos.coords.longitude; loc.accuracy=pos.coords.accuracy; loc.ts=Date.now();
      setGpsText('GPS: '+loc.lat.toFixed(5)+','+loc.lng.toFixed(5)+' ±'+Math.round(pos.coords.accuracy)+'m');
      refreshDistances();
    }, function(err){ setGpsText('GPS error: '+err.message); }, { enableHighAccuracy:true, timeout:10000, maximumAge:2000 });
  }catch(e){ setGpsText('GPS error'); }
}
gpsBtn.addEventListener('click', startGPS);
function haversine(a,b,c,d){ if([a,b,c,d].some(v=>v==null)) return Infinity; const R=6371000,toR=x=>x*Math.PI/180; const dLa=toR(c-a), dLo=toR(d-b); const A=Math.sin(dLa/2)**2+Math.cos(toR(a))*Math.cos(toR(c))*Math.sin(dLo/2)**2; return 2*R*Math.asin(Math.sqrt(A)); }
function staticMapURL({lat1,lng1,lat2,lng2}){ const p=new URLSearchParams({ center:String(lat2||lat1)+','+String(lng2||lng1), zoom:'15', size:'640x280', markers:[lat1&&lng1?(lat1+','+lng1+',blue'):'', lat2&&lng2?(lat2+','+lng2+',red'):''].filter(Boolean).join('|') }); return 'https://staticmap.openstreetmap.de/staticmap.php?'+p.toString(); }
const tbody=document.querySelector('#assignTbl tbody');
let rowsData=[];
function refreshTable(){
  const links=FM.listLinksForPromoter(ME.id);
  rowsData = links.map(l=>{ const s=FM.storeById(l.storeId), c=FM.campaignById(l.campaignId); return { link:l, store:s, camp:c, dist:haversine(loc.lat,loc.lng,s&&s.lat,s&&s.lng) }; });
  tbody.innerHTML='';
  rowsData.forEach((r,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td><a href="#" data-open="${idx}">${r.store?.name||'Store'}</a></td><td>${r.store?.region||'-'}</td><td>${r.camp?.title||'-'}</td><td class="distCell">${isFinite(r.dist)?Math.round(r.dist)+' m':'—'}</td><td style="text-align:right"><button class="btn" data-checkin="${idx}">Check in</button> <button class="btn-ghost" data-checkout="${idx}">End</button></td>`; tbody.appendChild(tr); });
}
function refreshDistances(){ Array.from(tbody.querySelectorAll('tr')).forEach((tr,i)=>{ const r=rowsData[i]; const d=haversine(loc.lat,loc.lng,r.store&&r.store.lat,r.store&&r.store.lng); r.dist=d; const cell=tr.querySelector('.distCell'); if(cell) cell.textContent = isFinite(d)?(Math.round(d)+' m'):'—'; }); }
refreshTable();
const mapBox=document.getElementById('mapBox'); const mapImg=document.getElementById('mapImg'); const mapNote=document.getElementById('mapNote');
function showMap(cur, store){ if(!cur||cur.lat==null||cur.lng==null||!store){ mapBox.style.display='none'; return; } mapImg.src = staticMapURL({lat1:cur.lat,lng1:cur.lng,lat2:store.lat,lng2:store.lng}); mapBox.style.display='block'; mapNote.textContent='You (blue) → Store (red) — acc ±'+(cur.accuracy?Math.round(cur.accuracy):'?')+'m'; }
tbody.addEventListener('click', function(e){
  const open=e.target.getAttribute && e.target.getAttribute('data-open');
  const idx = open!=null ? Number(open) : null; if(idx!=null){ const r=rowsData[idx]; showMap(loc, r.store); e.preventDefault(); }
  const ci=e.target.getAttribute && e.target.getAttribute('data-checkin'); const co=e.target.getAttribute && e.target.getAttribute('data-checkout');
  const uiRadius = Number((document.getElementById('geoRadius')||{}).value)||150; const allowOverride = !!((document.getElementById('geoOverride')||{}).checked);
  if(ci!=null){ const r=rowsData[Number(ci)], s=r.store, c=r.camp; const radius = Number((s&&s.geoRadius)||(c&&c.geoRadius)||uiRadius||150); const dist = haversine(loc.lat,loc.lng,s&&s.lat,s&&s.lng); showMap(loc, s); if(!(allowOverride || (isFinite(dist) && dist<=radius))){ toast('Too far: '+(isFinite(dist)?Math.round(dist):'unknown')+' m (limit '+radius+' m)', false); return; } const rec = FM.startShift({promoterId:ME.id, storeId:s.id, campaignId:(c&&c.id)||null, startLoc:loc}); toast('Checked in ✓'); localStorage.setItem('fm_lastShiftId', rec.id); }
  if(co!=null){ const lastId = localStorage.getItem('fm_lastShiftId'); try{ if(lastId){ FM.endShift({shiftId:lastId, endLoc:loc}); toast('Ended ✓'); } else { toast('No active shift found', false); } }catch(err){ toast(err.message||'End failed', false); } }
}, true);
</script>
<
/
m
a
i
n
>


<
d
i
v
 
i
d
=
"
t
o
a
s
t
"
 
c
l
a
s
s
=
"
t
o
a
s
t
"
>
<
/
d
i
v
>


<
/
b
o
d
y
>
<
/
h
t
m
l
>