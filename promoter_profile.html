<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>FindMe — Promoter Profile (Offline)</title>
<link rel="icon" href="assets/logo.png">
<link rel="apple-touch-icon" href="assets/icon-192.png">
<link rel="manifest" href="site.webmanifest">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
</head><body>
<header class="hdr">
  <div class="brand">
    <img class="brand-logo" src="assets/logo.png" alt="FindMe logo">
    <div class="brand-text">
      <span class="brand-name">FindMe</span>
      <span class="brand-tag">Campaign Staffing</span>
    </div>
  </div>
  <div class="hdr-right">
    <nav class="nav">
  <a class="chip" href="dashboard.html">Dashboard</a>
  <a class="chip" id="navSuper" href="super.html">Super</a>
  <button id="logoutBtn" class="btn-ghost">Logout</button>
</nav>
    <button class="btn-ghost icon" id="navToggle" aria-label="Menu">☰</button>
  </div>
</header>
<main class="container">
  <div class="card">
    <h2 style="margin-top:0">Update Profile</h2>
    <div class="grid grid-2">
      <div>
        <div class="grid grid-2">
          <div><label>First Name</label><input id="firstName"/></div>
          <div><label>Surname</label><input id="surname"/></div>
          <div><label>South African ID</label><input id="idNumber"/></div>
          <div><label>Email</label><input id="email"/></div>
          <div><label>CV File Name</label><input id="cvName"/></div>
          <div><label>Region (Province)</label><select id="region"><option>Eastern Cape</option><option>Free State</option><option>Gauteng</option><option>KwaZulu-Natal</option><option>Limpopo</option><option>Mpumalanga</option><option>North West</option><option>Northern Cape</option><option>Western Cape</option></select></div>
          <div><label>Ethnicity</label><select id="ethnicity"><option>Black</option><option>White</option><option>Indian</option><option>Coloured</option></select></div>
          <div><label>Gender</label><select id="gender"><option>Male</option><option>Female</option></select></div>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Formal Picture</h3>
        <div class="grid" style="grid-template-columns:160px 1fr">
          <img id="photoPreview" class="avatar" src="assets/icon-192.png" alt="Formal picture preview"/>
          <div>
            <p class="small">Upload a formal portrait (stored locally for this offline demo).</p>
            <input id="photoInput" type="file" accept="image/*"/>
            <div class="grid grid-2" style="margin-top:10px">
              <button id="savePhotoBtn" class="btn">Save photo</button>
              <button id="removePhotoBtn" class="btn-ghost">Remove photo</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin:0">Banking Details (Private)</h3>
      <p class="small">Saved to a private local entry on your device for testing.</p>
      <div class="grid grid-3">
        <div>
          <label>Bank</label>
          <select id="bankName">
            <option value="">Select bank…</option>
            <option>Absa</option><option>Capitec</option><option>FNB</option><option>Nedbank</option>
            <option>Standard Bank</option><option>Investec</option><option>TymeBank</option>
            <option>African Bank</option><option>Bidvest Bank</option><option>Discovery Bank</option><option>Postbank</option>
          </select>
        </div>
        <div>
          <label>Account Number</label>
          <input id="accountNumber" placeholder="e.g. 1234567890" inputmode="numeric" pattern="\d*"/>
          <p class="small" id="acctHint">Numbers only, 6–16 digits.</p>
        </div>
        <div>
          <label>Account Type</label>
          <select id="accountType">
            <option value="">Select…</option>
            <option>Savings</option><option>Cheque</option><option>Current</option>
          </select>
        </div>
      </div>
      <div class="grid grid-2" style="margin-top:12px">
        <button id="saveBankBtn" class="btn">Save Banking Details</button>
        <span class="small" id="bankStatus"></span>
      </div>
    </div>

    <div class="grid grid-2" style="margin-top:14px">
      <button id="saveBtn" class="btn">Save Profile</button>
      <a class="btn-ghost" href="dashboard.html">Back to Dashboard</a>
    </div>
    <div id="msg"></div>
  </div>
</main>
<footer class='ftr'>© 2025 FindMe • All rights reserved</footer>
<script type="module">
import { onAuth, signOut, getUserDoc, updateUserDoc, uploadFormalPhoto, getUserPrivate, updateUserPrivate, showMsg } from './js/offline.js';
document.getElementById('logoutBtn').addEventListener('click', ()=>signOut().then(()=>location.href='login.html'));
function resizeImageFile(file, max=900, q=0.9){
  return new Promise((res,rej)=>{
    const img=new Image(), r=new FileReader();
    r.onload=e=>img.src=e.target.result; img.onload=()=>{
      const c=document.createElement('canvas'); let w=img.width,h=img.height,s=Math.min(1,max/Math.max(w,h));
      c.width=Math.round(w*s); c.height=Math.round(h*s); c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      res(c.toDataURL('image/jpeg',q));
    }; r.onerror=rej; r.readAsDataURL(file);
  });
}
let me=null;
onAuth(async (u)=>{
  if(!u){ location.href='login.html'; return; }
  me = await getUserDoc(u.id);
  firstName.value=me.firstName||''; surname.value=me.surname||''; idNumber.value=me.idNumber||''; email.value=me.email||''; cvName.value=me.cvName||''; region.value=me.region||'Gauteng'; ethnicity.value=me.ethnicity||'Black'; gender.value=me.gender||'Male';
  if(me.photoFormal) photoPreview.src=me.photoFormal;
  const priv = await getUserPrivate(u.id) || {};
  bankName.value = priv.bankName || ''; accountNumber.value = priv.accountNumber || ''; accountType.value = priv.accountType || '';
});
saveBtn.addEventListener('click', async ()=>{
  if(!me) return;
  await updateUserDoc(me.id, { firstName:firstName.value.trim(), surname:surname.value.trim(), idNumber:idNumber.value.trim(), email:email.value.trim(), cvName:cvName.value.trim(), region:region.value, ethnicity:ethnicity.value, gender:gender.value });
  showMsg('Profile saved.');
});
photoInput.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const data=await resizeImageFile(f,900,0.9); photoPreview.src=data; photoPreview.dataset.pending=data; });
savePhotoBtn.addEventListener('click', async ()=>{ if(!me) return; const pending=photoPreview.dataset.pending||photoPreview.src; if(!pending) return; const url=await uploadFormalPhoto(me.id, pending); photoPreview.src=url; delete photoPreview.dataset.pending; showMsg('Formal photo saved.'); });
removePhotoBtn.addEventListener('click', async ()=>{ if(!me) return; await updateUserDoc(me.id, { photoFormal: null }); photoPreview.src='assets/icon-192.png'; showMsg('Formal photo removed.'); });
function validAccount(num){ return /^\d{6,16}$/.test((num||'').replace(/\s+/g,'')); }
saveBankBtn.addEventListener('click', async ()=>{
  if(!me) return;
  const bank=bankName.value, acct=accountNumber.value.replace(/\s+/g,''), type=accountType.value;
  if(!bank) return showMsg('Select a bank.','error');
  if(!validAccount(acct)) return showMsg('Account number must be 6–16 digits.','error');
  if(!type) return showMsg('Select an account type.','error');
  await updateUserPrivate(me.id, { bankName:bank, accountNumber:acct, accountType:type });
  document.getElementById('bankStatus').textContent = 'Saved ✓';
  showMsg('Banking details saved.');
});
</script>
<script>document.addEventListener('click',e=>{if(e.target?.id==='navToggle'){document.querySelector('.nav')?.classList.toggle('open')}if(e.target?.closest('.nav')&&e.target.tagName==='A'){document.querySelector('.nav')?.classList.remove('open')}});</script>
<script type="module">
import { onAuth, getUserDoc } from './js/offline.js';
onAuth(async (u)=>{
  const link=document.getElementById('navSuper'); if(!link) return;
  const you = u ? await getUserDoc(u.id||u) : null;
  link.style.display = (you && you.role==='super') ? 'inline-flex' : 'none';
});
</script>
</body></html>