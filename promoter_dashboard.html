<!doctype html>
<html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FindMe! — Promoter Dashboard</title><link rel="stylesheet" href="assets/style.css"/></head>
<body><div class="container">
  <div id="nav" class="nav"><div class="brand">FindMe<span style="color:#22c55e">!</span></div></div>
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h1>Available Campaigns</h1>
      <a class="btn secondary" href="promoter_profile.html">Edit Profile</a>
    </div>
    <p class="kicker">Filtered by your region</p>
    <div id="list" class="grid"></div>
  </div>
  <footer class="small">FindMe! • Firebase Auth + Firestore + Storage</footer>
</div>
<script type="module">
  import { auth, db } from './js/firebase.js';
  import { Auth } from './js/auth.js';
  import { Campaigns, Applications } from './js/campaigns.js';
  import { UI } from './js/ui.js';
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  let profile = null;
  Auth.onChange(async (u)=>{
    if (!u) { location.href='login.html'; return; }
    const snap = await getDoc(doc(db,'users', u.uid));
    profile = snap.data();
    if (profile.role !== 'promoter') { location.href = 'company_dashboard.html'; return; }
    render();
  });

  async function render(){
    const root = document.querySelector('#list');
    const list = await Campaigns.forRegion(profile.region);
    if (!list.length) { root.innerHTML = UI.empty('No campaigns in your region yet.'); return; }
    const appliedIds = new Set();
    for (const c of list) {
      const apps = await Applications.forPromoterCampaign({campaignId: c.id, promoterId: auth.currentUser.uid});
      if (apps.length) appliedIds.add(c.id);
    }
    root.innerHTML = list.map(c => UI.campaignCard(c, {showRegion:false, showApply:true, applied: appliedIds.has(c.id)})).join('');
    root.querySelectorAll('[data-apply]').forEach(btn => {
      btn.addEventListener('click', async (e)=>{
        const id = e.currentTarget.getAttribute('data-apply');
        await Applications.create({campaignId:id, promoterId: auth.currentUser.uid});
        e.currentTarget.disabled = true; UI.toast('Application sent');
      });
    });
  }
</script></body></html>
