
import { getDB, setDB, uid } from './storage.js';
import { loginAdmin, getSession, clearSession } from './auth.js';
import { $, toast, showStoresLinkIfAdmin } from './ui.js';
import { PROVINCES } from './constants.js';
function render(){const s=getSession("admin");const authed=!!s;$("#stores-login").classList.toggle("hidden",authed);$("#stores-app").classList.toggle("hidden",!authed);showStoresLinkIfAdmin();if(authed){$("#admin-name").textContent=s.name;hydrate();renderStores()}}
function hydrate(){const sel=$("#s-province");if(sel&&!sel.dataset.bound){sel.innerHTML=`<option value="">Select province</option>`+PROVINCES.map(p=>`<option value="${p}">${p}</option>`).join("");sel.dataset.bound="1"}const db=getDB();$("#rep-campaign").innerHTML=`<option value="">Any campaign</option>`+db.campaigns.map(c=>`<option value="${c.id}">${c.title} • ${c.location}</option>`).join("");$("#rep-store").innerHTML=`<option value="">Any store</option>`+db.stores.map(s=>`<option value="${s.id}">${s.name} • ${s.city}</option>`).join("");const d=new Date(),y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),da=String(d.getDate()).padStart(2,"0");$("#rep-from").value=`${y}-${m}-01`;$("#rep-to").value=`${y}-${m}-${da}`}
function onLogin(e){e.preventDefault();try{const a=loginAdmin({email:$("#adm-email").value.trim(),password:$("#adm-pass").value.trim()});toast(`Welcome ${a.name}!`);render()}catch(err){toast(err.message,"err")}}
function onLogout(){clearSession("admin");render()}
function renderStores(){const db=getDB();const tb=$("#stores-tbody");tb.innerHTML="";db.stores.forEach(s=>{const tr=document.createElement("tr");tr.innerHTML=`<td><strong>${s.name}</strong><div class="small muted">${s.address}</div></td><td>${s.city}</td><td>${s.province}</td><td class="small muted">${(s.lat!=null&&s.lng!=null)?`Geo: ${s.lat.toFixed(5)}, ${s.lng.toFixed(5)} • ${s.radius||250}m`:"Geo: not set"}</td>`;tb.appendChild(tr)})}
function onCreateStore(e){e.preventDefault();const name=$("#s-name").value.trim(),province=$("#s-province").value,city=$("#s-city").value.trim(),address=$("#s-address").value.trim();const lat=parseFloat($("#s-lat").value||""),lng=parseFloat($("#s-lng").value||""),radius=parseInt($("#s-radius").value||"250",10);if(!name||!province||!city||!address){toast("Fill all store fields.","warn");return}const db=getDB();db.stores.unshift({id:uid("str"),name,province,city,address,lat:isNaN(lat)?null:lat,lng:isNaN(lng)?null:lng,radius:isNaN(radius)?250:radius});setDB(db);toast("Store added.");e.target.reset();renderStores()}
function loadReport(){const db=getDB();const storeId=$("#rep-store").value,campaignId=$("#rep-campaign").value,frm=$("#rep-from").value,to=$("#rep-to").value;const fd=new Date(frm+"T00:00:00"),td=new Date(to+"T23:59:59");const rows=db.checkins.filter(ci=>{const t=new Date(ci.start).getTime();if(storeId&&ci.storeId!==storeId)return false;if(campaignId&&ci.campaignId!==campaignId)return false;return t>=fd.getTime()&&t<=td.getTime()});const agg={};rows.forEach(ci=>{if(!ci.end)return;agg[ci.promoterId]=(agg[ci.promoterId]||0)+Math.max(0,Math.floor(ci.seconds||0))});const tb=$("#rep-tbody");tb.innerHTML="";Object.entries(agg).forEach(([pid,sec])=>{const u=db.users.find(x=>x.id===pid);const tr=document.createElement("tr");tr.innerHTML=`<td><strong>${u?.name||"Unknown"}</strong><div class="small muted">${u?.email||""}</div></td><td>${sec}</td><td>${(sec/3600).toFixed(2)}</td>`;tb.appendChild(tr)});$("#rep-title").textContent=`Report — ${frm} to ${to}`}
function downloadCSV(){const db=getDB();const storeId=$("#rep-store").value,campaignId=$("#rep-campaign").value,frm=$("#rep-from").value,to=$("#rep-to").value;const fd=new Date(frm+"T00:00:00"),td=new Date(to+"T23:59:59");const rows=db.checkins.filter(ci=>{const t=new Date(ci.start).getTime();if(storeId&&ci.storeId!==storeId)return false;if(campaignId&&ci.campaignId!==campaignId)return false;return t>=fd.getTime()&&t<=td.getTime()});const agg={};rows.forEach(ci=>{if(!ci.end)return;agg[ci.promoterId]=(agg[ci.promoterId]||0)+Math.max(0,Math.floor(ci.seconds||0))});const header=["Promoter Name","Promoter Email","Total Seconds","Total Hours"];const lines=[header.join(",")];Object.entries(agg).forEach(([pid,sec])=>{const u=db.users.find(x=>x.id===pid);lines.push([ (u?.name||"").replace(/,/g," "), (u?.email||"").replace(/,/g," "), sec, (sec/3600).toFixed(2) ].join(","))});const csv=lines.join("\\n");const blob=new Blob([csv],{type:"text/csv"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=`hours_${frm}_to_${to}.csv`;document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url)},100)}
document.addEventListener("DOMContentLoaded",()=>{render();$("#stores-login-form")?.addEventListener("submit",onLogin);$("#logout-btn")?.addEventListener("click",onLogout);$("#create-store-form")?.addEventListener("submit",onCreateStore);$("#load-report")?.addEventListener("click",loadReport);$("#download-btn")?.addEventListener("click",downloadCSV)});
