<!doctype html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>FindMe — Store Details</title><link rel='stylesheet' href='css/style.css'></head><body>
<header class="hdr">
  <div class="brand">
    <img class="brand-logo" src="assets/logo.png" alt="FindMe logo">
    <div class="brand-text">
      <span class="brand-name">FindMe</span>
      <span class="brand-tag">Campaign Staffing</span>
    </div>
  </div>
  <div class="hdr-right">
    <nav id="mainNav" class="nav"><button id="navToggle" class="nav-toggle" aria-label="Menu" aria-expanded="false" aria-controls="mainNav">☰</button><div class="nav-items">
      <a class="chip" href="index.html">Home</a>
      <a class="chip" href="dashboard.html">Dashboard</a>
      <a class="chip" href="update_profile.html">Profile</a>
      <a class="chip" id="navPromoters" href="promoters.html">Promoters</a>
      <a class="chip" id="navStores" href="stores.html">Stores</a>
      <a class="chip" id="navPost" href="post_campaign.html">Post Campaign</a>
      <a class="chip" id="navActive" href="active_campaigns.html">Active Campaigns</a>
      <a class="chip" id="navSuper" href="super.html">Super</a>
      <a class="chip" href="signup.html">Create account</a>
      <button id="logoutBtn" class="btn-ghost">Logout</button>
    </div></nav>

<script>
// Role-based nav hide (fast, before modules)
(function(){
  try{
    var s = JSON.parse(localStorage.getItem('fm_session')||'{}');
    var users = JSON.parse(localStorage.getItem('fm_users')||'[]');
    var me = users.find(function(u){ return u.id===s.uid; }) || null;
    if(me && me.role==='promoter'){
      ['navPromoters','navStores','navPost','navSuper'].forEach(function(id){
        var el=document.getElementById(id); if(el) el.style.display='none';
      });
    }
  }catch(e){}
})();
</script>

    <button class="btn-ghost icon" id="navToggle" aria-label="Menu">☰</button>
  </div>
</header>
<script type="module">
import { onAuth, getUserDoc, signOut } from './js/offline.js';
document.getElementById('navToggle').addEventListener('click', ()=>document.querySelector('.nav').classList.toggle('open'));
const lg = document.getElementById('logoutBtn'); if(lg) lg.addEventListener('click', ()=>signOut().then(()=>location.href='login.html'));
onAuth(async (u)=>{ 
  const me = u ? await getUserDoc(u.id||u) : null;
  const isCompany = me && me.role==='company'; const isPromoter = me && me.role==='promoter'; const isSuper = me && me.role==='super';
  const show = (id, ok)=>{ const el=document.getElementById(id); if(el) el.style.display = ok?'inline-flex':'none'; };
  show('navPromoters', isCompany); show('navStores', isCompany); show('navPost', isCompany);
  show('navActive', (isCompany||isPromoter)); show('navSuper', isSuper);
});
</script>

<main class="container">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <div>
        <h2 id="storeTitle" style="margin:0">Store</h2>
        <div id="storeMeta" class="small"></div>
      </div>
      <button id="deleteStoreBtn" class="btn-danger">Delete Store</button>
    </div>
  </div>

  <div class="grid grid-2" style="margin-top:12px">
    <div class="card">
      <h3 style="margin-top:0">Assigned Promoters</h3>
      <div class="table-wrap">
        <table class="table" id="assignedTable">
          <thead><tr><th>Name</th><th>Email</th><th>Unassign</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Assign Promoters</h3>
      <div class="grid grid-3">
        <div><label>Search</label><input id="q" placeholder="Name or email"></div>
        <div><label>Region</label>
          <select id="pRegion">
            <option value=''>All</option><option>Eastern Cape</option><option>Free State</option><option>Gauteng</option><option>KwaZulu-Natal</option>
            <option>Limpopo</option><option>Mpumalanga</option><option>North West</option><option>Northern Cape</option><option>Western Cape</option>
          </select>
        </div>
        <div class="grid" style="grid-template-columns:1fr auto;align-items:end"><div></div><button id="searchBtn" class="btn">Search</button></div>
      </div>
      <div class="table-wrap" style="margin-top:8px">
        <table class="table" id="promoterTable">
          <thead><tr><th><input type="checkbox" id="selAll"></th><th>Name</th><th>Region</th><th>Email</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <button id="assignSelected" class="btn">Assign selected</button>
        <span id="assignMsg" class="small"></span>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 style="margin-top:0">Recent Check-ins</h3>
    <div class="table-wrap">
      <table class="table" id="checkinsTable">
        <thead><tr><th>When</th><th>Promoter</th><th>Distance</th><th>Within 200m?</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<footer class="ftr">© 2025 FindMe • All rights reserved</footer>

<script type="module">
import { onAuth, getUserDoc, getStore, deleteStore, listPromoters, listStoreAssignments, assignPromoterToStore, unassignPromoterFromStore, listCheckinsForStore } from './js/offline.js';
const params=new URLSearchParams(location.search); const STORE_ID=params.get('id'); let ME=null, STORE=null, PROM=[];
onAuth(async (u)=>{ if(!u){ location.href='login.html'; return; } ME=await getUserDoc(u.id||u); if(ME.role!=='company') location.href='dashboard.html'; if(!STORE_ID){ alert('Missing store id'); location.href='stores.html'; return; } STORE=await getStore(STORE_ID); if(!STORE){ alert('Store not found'); location.href='stores.html'; return; } hydrate(); PROM=await listPromoters(); await renderAssigned(); await renderCheckins(); pRegion.value=''; await renderSearch(); });
function hydrate(){ storeTitle.textContent=STORE.name+(STORE.code?(' — '+STORE.code):''); storeMeta.textContent='Region: '+(STORE.region||'-')+' • Address: '+(STORE.address||'-')+' • Lat/Lng: '+(STORE.lat+', '+STORE.lng); }
deleteStoreBtn.addEventListener('click', async ()=>{ if(confirm('Delete this store? Assignments and check-ins for it will also be removed.')){ await deleteStore(ME.id, STORE_ID); location.href='stores.html'; } });
searchBtn.addEventListener('click', renderSearch); selAll.addEventListener('change', (e)=>{ document.querySelectorAll('#promoterTable tbody input[type="checkbox"]').forEach(cb=>cb.checked=e.target.checked); });
async function renderSearch(){ const qtxt=(q.value||'').toLowerCase(); const region=pRegion.value; const list=PROM.filter(p=>(!region||p.region===region)&&(!qtxt||(((p.firstName||'')+' '+(p.surname||'')+' '+(p.email||'')).toLowerCase().includes(qtxt)))); const tb=document.querySelector('#promoterTable tbody'); tb.innerHTML=''; if(list.length===0){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="4"><div class="small">No promoters match your filters. Try selecting <strong>All</strong> region or clearing search.</div></td>'; tb.appendChild(tr); } else { list.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML='<td><input type="checkbox" data-pid="'+p.id+'"></td><td>'+ (p.firstName||'') +' '+ (p.surname||'') +'</td><td>'+ (p.region||'-') +'</td><td>'+ (p.email||'-') +'</td>'; tb.appendChild(tr); }); } selAll.checked=false; }
async function renderAssigned(){ const assigned=await listStoreAssignments(STORE_ID); const users=JSON.parse(localStorage.getItem('fm_users')||'[]'); const byId=Object.fromEntries(users.map(u=>[u.id,u])); const tb=document.querySelector('#assignedTable tbody'); tb.innerHTML=''; assigned.forEach(a=>{ const p=byId[a.promoterId]; const name=((p?.firstName||'')+' '+(p?.surname||'')).trim(); const tr=document.createElement('tr'); tr.innerHTML='<td>'+ name +'</td><td>'+ (p?.email||'-') +'</td><td><button class="btn-ghost" data-unassign="'+a.id+'">Remove</button></td>'; tb.appendChild(tr); }); }
async function renderCheckins(){ const list=await listCheckinsForStore(STORE_ID); const users=JSON.parse(localStorage.getItem('fm_users')||'[]'); const byId=Object.fromEntries(users.map(u=>[u.id,u])); const tb=document.querySelector('#checkinsTable tbody'); tb.innerHTML=''; list.forEach(c=>{ const p=byId[c.promoterId]; const name=((p?.firstName||'')+' '+(p?.surname||'')).trim(); const ok=c.withinRadius?'Yes':'No'; const dist=(c.distanceMeters!=null)?(c.distanceMeters+' m'):'-'; const tr=document.createElement('tr'); tr.innerHTML='<td>'+ (new Date(c.when).toLocaleString()) +'</td><td>'+ (name||c.promoterId) +'</td><td>'+ dist +'</td><td>'+ ok +'</td>'; tb.appendChild(tr); }); }
document.getElementById('assignedTable').addEventListener('click', async (e)=>{ const id=e.target.closest('button[data-unassign]')?.getAttribute('data-unassign'); if(!id) return; await unassignPromoterFromStore(id); await renderAssigned(); });
assignSelected.addEventListener('click', async ()=>{ const sel=Array.from(document.querySelectorAll('#promoterTable tbody input[type="checkbox"]:checked')).map(cb=>cb.getAttribute('data-pid')); if(sel.length===0){ assignMsg.textContent='Select at least one promoter.'; return; } for(const pid of sel) await assignPromoterToStore({ ownerId:ME.id, storeId:STORE_ID, promoterId:pid }); assignMsg.textContent='Assigned '+sel.length+' promoter(s).'; await renderAssigned(); setTimeout(()=>assignMsg.textContent='', 1500); });
</script>
<div id="toast" class="toast"></div>

<script>
function toast(msg, ok=true){ const el=document.getElementById('toast'); if(!el) return; el.textContent=msg; el.style.background=ok?'#111':'#b00'; el.classList.add('show'); setTimeout(()=>{ el.classList.remove('show'); }, 1800); }
</script>

<script>
// mobile nav toggle binder
(function(){ var btn=document.getElementById('navToggle'); var nav=document.getElementById('mainNav')||document.querySelector('.nav'); if(btn && nav && !btn.dataset.bnd){ btn.dataset.bnd='1'; btn.addEventListener('click', function(){ var isOpen=nav.classList.toggle('open'); btn.setAttribute('aria-expanded', isOpen?'true':'false'); }); } })();
</script>

<script>
// mobile nav toggle binder v2
(function(){
  var btn = document.getElementById('navToggle');
  var nav = document.getElementById('mainNav');
  if(btn && nav && !btn.dataset.bnd){
    btn.dataset.bnd = '1';
    btn.addEventListener('click', function(){
      var isOpen = nav.classList.toggle('open');
      btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    });
  }
})();
</script>

<script>
// mobile nav toggle binder v3
(function(){
  var nav = document.getElementById('mainNav');
  var btn = document.getElementById('navToggle');
  if(!nav || !btn) return;
  if(!btn.dataset.bnd){
    btn.dataset.bnd = '1';
    btn.addEventListener('click', function(){
      var isOpen = nav.classList.toggle('open');
      btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    });
    var items = nav.querySelector('.nav-items');
    if(items){
      items.addEventListener('click', function(e){
        var target = e.target;
        if(target.tagName === 'A' || target.closest('a')){
          nav.classList.remove('open');
          btn.setAttribute('aria-expanded', 'false');
        }
      });
    }
    if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches){
      nav.classList.remove('open');
      btn.setAttribute('aria-expanded', 'false');
    }
  }
})();
</script>

<script>
// burger binder v4 + diagnostics + FAB fallback
(function(){
  var nav = document.getElementById('mainNav');
  var btn = document.getElementById('navToggle');
  // Insert FAB fallback if missing
  var fab = document.getElementById('navFab');
  if(!fab){
    fab = document.createElement('button');
    fab.id = 'navFab';
    fab.className = 'nav-fab';
    fab.setAttribute('aria-label','Menu');
    fab.textContent = '☰';
    document.body.appendChild(fab);
  }
  function toggleNav(){
    if(!nav) return;
    var isOpen = nav.classList.toggle('open');
    if(btn) btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    console.debug('[burger] toggle ->', isOpen);
  }
  function closeNav(){
    if(!nav) return;
    nav.classList.remove('open');
    if(btn) btn.setAttribute('aria-expanded', 'false');
  }
  // Guard against duplicate binding
  if(btn && !btn.dataset.bnd){ btn.dataset.bnd='1'; btn.addEventListener('click', toggleNav); }
  if(fab && !fab.dataset.bnd){ fab.dataset.bnd='1'; fab.addEventListener('click', toggleNav); }
  // Close on link tap
  var items = nav && nav.querySelector('.nav-items');
  if(items && !items.dataset.bnd){
    items.dataset.bnd = '1';
    items.addEventListener('click', function(e){
      if(e.target.tagName === 'A' || (e.target.closest && e.target.closest('a'))){ closeNav(); }
    });
  }
  // Start closed on small screens
  try {
    if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches){
      closeNav();
    }
  } catch(e){}
  // Diagnostics
  console.debug('[burger] ready', { hasNav: !!nav, hasBtn: !!btn, hasFab: !!fab });
})();
</script>

</body></html>




